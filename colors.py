import math
import colorsys

import re

from utility.files_util import load_json

TOTAL_PIXELS = 16384

PIXELS_COLORS = {
    (0, 0, 0): 30733152,
    (0, 0, 64): 11027495,
    (0, 0, 128): 6924735,
    (0, 0, 192): 27156755,
    (0, 64, 0): 11013810,
    (0, 64, 64): 8847167,
    (0, 64, 128): 6338027,
    (0, 64, 192): 8507705,
    (0, 128, 0): 6936964,
    (0, 128, 64): 6342332,
    (0, 128, 128): 4134258,
    (0, 128, 192): 4638028,
    (0, 192, 0): 27125076,
    (0, 192, 64): 8499094,
    (0, 192, 128): 4639235,
    (0, 192, 192): 18066128,
    (64, 0, 0): 10981883,
    (64, 0, 64): 8836531,
    (64, 0, 128): 6341185,
    (64, 0, 192): 8571245,
    (64, 64, 0): 8819809,
    (64, 64, 64): 9795114,
    (64, 64, 128): 7142948,
    (64, 64, 192): 6149683,
    (64, 128, 0): 6348108,
    (64, 128, 64): 7150363,
    (64, 128, 128): 4864719,
    (64, 128, 192): 4063175,
    (64, 192, 0): 8559726,
    (64, 192, 64): 6145819,
    (64, 192, 128): 4056261,
    (64, 192, 192): 5443380,
    (128, 0, 0): 6957201,
    (128, 0, 64): 6344203,
    (128, 0, 128): 4157997,
    (128, 0, 192): 4661192,
    (128, 64, 0): 6351863,
    (128, 64, 64): 7138033,
    (128, 64, 128): 4878471,
    (128, 64, 192): 4062180,
    (128, 128, 0): 4162628,
    (128, 128, 64): 4872188,
    (128, 128, 128): 3088013,
    (128, 128, 192): 2440186,
    (128, 192, 0): 4672436,
    (128, 192, 64): 4055608,
    (128, 192, 128): 2444511,
    (128, 192, 192): 2704459,
    (192, 0, 0): 27031542,
    (192, 0, 64): 8478252,
    (192, 0, 128): 4657920,
    (192, 0, 192): 18163490,
    (192, 64, 0): 8531671,
    (192, 64, 64): 6121071,
    (192, 64, 128): 4056579,
    (192, 64, 192): 5422424,
    (192, 128, 0): 4662234,
    (192, 128, 64): 4052847,
    (192, 128, 128): 2443360,
    (192, 128, 192): 2731807,
    (192, 192, 0): 18196368,
    (192, 192, 64): 5411563,
    (192, 192, 128): 2741118,
    (192, 192, 192): 9960371
}

COLOR_RANKING = {
    (0, 0, 0): 64,
    (0, 0, 64): 57,
    (0, 0, 128): 38,
    (0, 0, 192): 63,
    (0, 64, 0): 56,
    (0, 64, 64): 52,
    (0, 64, 128): 32,
    (0, 64, 192): 46,
    (0, 128, 0): 39,
    (0, 128, 64): 34,
    (0, 128, 128): 14,
    (0, 128, 192): 17,
    (0, 192, 0): 62,
    (0, 192, 64): 45,
    (0, 192, 128): 18,
    (0, 192, 192): 58,
    (64, 0, 0): 55,
    (64, 0, 64): 51,
    (64, 0, 128): 33,
    (64, 0, 192): 49,
    (64, 64, 0): 50,
    (64, 64, 64): 53,
    (64, 64, 128): 42,
    (64, 64, 192): 31,
    (64, 128, 0): 36,
    (64, 128, 64): 43,
    (64, 128, 128): 23,
    (64, 128, 192): 13,
    (64, 192, 0): 48,
    (64, 192, 64): 30,
    (64, 192, 128): 10,
    (64, 192, 192): 28,
    (128, 0, 0): 40,
    (128, 0, 64): 35,
    (128, 0, 128): 15,
    (128, 0, 192): 20,
    (128, 64, 0): 37,
    (128, 64, 64): 41,
    (128, 64, 128): 25,
    (128, 64, 192): 12,
    (128, 128, 0): 16,
    (128, 128, 64): 24,
    (128, 128, 128): 7,
    (128, 128, 192): 1,
    (128, 192, 0): 22,
    (128, 192, 64): 9,
    (128, 192, 128): 3,
    (128, 192, 192): 4,
    (192, 0, 0): 61,
    (192, 0, 64): 44,
    (192, 0, 128): 19,
    (192, 0, 192): 59,
    (192, 64, 0): 47,
    (192, 64, 64): 29,
    (192, 64, 128): 11,
    (192, 64, 192): 27,
    (192, 128, 0): 21,
    (192, 128, 64): 8,
    (192, 128, 128): 2,
    (192, 128, 192): 5,
    (192, 192, 0): 60,
    (192, 192, 64): 26,
    (192, 192, 128): 6,
    (192, 192, 192): 54
}


red = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192]
green = [0,0,0,0,64,64,64,64,128,128,128,128,192,192,192,192,0,0,0,0,64,64,64,64,128,128,128,128,192,192,192,192,0,0,0,0,64,64,64,64,128,128,128,128,192,192,192,192,0,0,0,0,64,64,64,64,128,128,128,128,192,192,192,192]
blue = [0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192,0,64,128,192]

COLOR_KEYS = list(zip(red, green, blue)) 

COLOR_HEX_URL = "https://www.color-hex.com"

def step (r,g,b, repetitions=1):
    lum = math.sqrt( .241 * r + .691 * g + .068 * b )
    h, s, v = colorsys.rgb_to_hsv(r,g,b)
    h2 = int(h * repetitions)
    lum2 = int(lum * repetitions)
    v2 = int(v * repetitions)
    if h2 % 2 == 1:
        v2 = repetitions - v2
        lum = repetitions - lum
    return (h2, lum, v2)

COLORS_SORTED = sorted(COLOR_KEYS, key=lambda rgb: step(rgb[0],rgb[1],rgb[2],8))


def rgb_2_hex(rgb: tuple):
    return "#{:02x}{:02x}{:02x}".format(*rgb)

def get_color_frequencies(idx: str) -> list:
    unsigs_colors = load_json("json/color_frequencies.json")
    color_frequencies = unsigs_colors.get(str(idx))

    return {tuple([int(n) for n in re.findall('[0-9]+', k)]): v for k,v in color_frequencies.items()}

def get_total_colors(color_frequencies: dict) -> int:
    return len([p for p in color_frequencies.values() if p])

def get_top_colors(color_frequencies: dict, num_ranks=10):
    colors_sorted = sorted(color_frequencies.items(), key=lambda x: x[1], reverse=True)

    return {k: v/TOTAL_PIXELS for k,v in dict(colors_sorted[:num_ranks]).items() if v != 0}

def link_hex_color(color_hex):
    color_hex = color_hex.replace("#", "")
    return f"{COLOR_HEX_URL}/color/{color_hex}"



